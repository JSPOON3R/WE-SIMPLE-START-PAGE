<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Start Page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: "";
            --secondary-color: "";
            --company-logo: "";
            --font: 'Roboto', sans-serif;
            --radius: 14px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: var(--font);
            background-image: url('src/radiant-gradient.svg') !important;
            background-size: cover !important;
            background-repeat: no-repeat !important;
            background-position-y: bottom !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            width: min(1100px, 92vw);
            height: 100vh;
            margin: 28px auto 48px;
            display: flex;
            justify-content: space-evenly;
            align-items: stretch;
            flex-direction: column;
        }

        /* Header */

        .brand {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .brand img {
            height: 100px;
            width: auto;
            display: block;
            margin-bottom: 8px;
        }

        .brand .title {
            font-weight: 300;
            font-size: 1.5rem;
            color: var(--primary-color);
            letter-spacing: .2px;
            margin-bottom: 25px;
        }

        .btn-container {
            Display: flex;
            gap: 10px;
        }

        /* Search bar */
        .search {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            background: white;
            border: 1px solid var(--secondary-color);
            border-radius: var(--radius);
            padding: 10px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
            margin: 10px 0 24px;
        }

        .search input[type="search"] {
            border: 1px solid var(--secondary-color);
            background: #fff;
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 1rem;
            outline: none;
            width: 100%;
        }

        .search button {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            border-radius: 15px;
            border: 1px solid var(--secondary-color);
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            margin: 0;
            cursor: pointer;
            transition-duration: 0.4s;
        }

        .search button:hover {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            border: 1px solid gray;
        }

        .search button:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px
        }

        /* Bookmarks grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 14px;
        }

        .card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: white;
            border: 1px solid transparent;
            border-radius: var(--radius);
            text-decoration: none;
            color: inherit;
            opacity: .9;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .04);
            transition: transform .06s ease, box-shadow .12s ease, border-color .12s ease;
        }

        .card:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, .08);
            border: 1px solid var(--primary-color);
        }

        .card .badge {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            font-weight: 700;
            color: var(--primary-color);
            font-size: .9rem;
            background: white;
            ;
        }

        .card .badge.link-badge {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--secondary-color);
            /* opaque circle */
            display: grid;
            place-items: center;
            overflow: hidden;
        }

        .card .badge.link-badge::before {
            content: "";
            width: 18px;
            height: 18px;
            display: block;
            background: var(--primary-color);
            /* tint color */
            -webkit-mask: url('src/link.png') center/contain no-repeat;
            /* mask PNG */
            mask: url('src/link.png') center/contain no-repeat;
        }

        .card .label {
            display: flex;
            flex-direction: column;
            line-height: 1.25;
        }

        .card .label .name {
            font-weight: 600;
            color: var(--primary-color);
        }

        .card .label .desc {
            font-size: .9rem;
            color: #666;
        }

        /* Footer note (optional) */
        .note {
            margin-top: 18px;
            width: 250px;
            font-size: .85rem;
            border-radius: 12px;
            padding: 6px 12px;
            align-self: center;
            background-color: var(--primary-color);
            color: var(--secondary-color);
            text-align: center;
        }

        @media (max-width:520px) {
            .brand img {
                height: 44px
            }

            header {
                margin-bottom: 20px;
                margin-top: 20px;
            }

            .search {
                grid-template-columns: 1fr;
                padding: 8px
            }

            .search button {
                width: 100%
            }
        }
    </style>
</head>

<body>
    <main class="container" role="main">
        <!-- Logo / header -->
        <header class="brand" aria-label="Company Logo">
            <img id="company-logo" src="" alt="logo">
            <div class="title">Select or Search</div>
        </header>

        <!-- Bookmarks -->
        <section aria-labelledby="quick-links">
            <h2 id="quick-links" class="visually-hidden" style="position:absolute;left:-9999px;">Quick links</h2>
            <div class="grid">
                <a class="card" href="https://www.amazon.com/" target="_blank" rel="noopener">
                    <span class="badge">
                        <img src="src/amazon-icon.webp" alt="Amazon" style="width:28px;height:auto;display:block;">
                    </span>
                    <span class="label">
                        <span class="name">Amazon</span>
                        <span class="desc">amazon.com</span>
                    </span>
                </a>

                <a class="card" href="https://www.facebook.com/" target="_blank" rel="noopener">
                    <span class="badge">
                        <img src="src/facebook-logo.png" alt="Facebook" style="width:28px;height:auto;display:block;">
                    </span>
                    <span class="label">
                        <span class="name">Facebook</span>
                        <span class="desc">facebook.com</span>
                    </span>
                </a>

                <a class="card" href="https://www.google.com/" target="_blank" rel="noopener">
                    <span class="badge">
                        <img src="src/google-logo.png" alt="Google" style="width:28px;height:auto;display:block;">
                    </span>
                    <span class="label">
                        <span class="name">Google</span>
                        <span class="desc">google.com</span>
                    </span>
                </a>

                <a class="card" href="https://www.instagram.com/" target="_blank" rel="noopener">
                    <span class="badge">
                        <img src="src/instagram-icon.png" alt="Instagram" style="width:28px;height:auto;display:block;">
                    </span>
                    <span class="label">
                        <span class="name">Instagram</span>
                        <span class="desc">instagram.com</span>
                    </span>
                </a>

                <a class="card" href="https://www.linkedin.com/" target="_blank" rel="noopener">
                    <span class="badge">
                        <img src="src/linkedin-icon.png" alt="LinkedIn" style="width:28px;height:auto;display:block;">
                    </span>
                    <span class="label">
                        <span class="name">LinkedIn</span>
                        <span class="desc">linkedin.com</span>
                    </span>
                </a>

                <a class="card" href="https://www.reddit.com/" target="_blank" rel="noopener">
                    <span class="badge">
                        <img src="src/reddit-icon.webp" alt="Reddit" style="width:28px;height:auto;display:block;">
                    </span>
                    <span class="label">
                        <span class="name">Reddit</span>
                        <span class="desc">reddit.com</span>
                    </span>
                </a>

                <a class="card" href="https://www.youtube.com/" target="_blank" rel="noopener">
                    <span class="badge">
                        <img src="src/youtube-logo.png" alt="YouTube" style="width:28px;height:auto;display:block;">
                    </span>
                    <span class="label">
                        <span class="name">YouTube</span>
                        <span class="desc">youtube.com</span>
                    </span>
                </a>

                <a class="card" href="https://www.x.com/" target="_blank" rel="noopener">
                    <span class="badge">
                        <img src="src/x-icon.png" alt="X (Twitter)" style="width:28px;height:auto;display:block;">
                    </span>
                    <span class="label">
                        <span class="name">X (Twitter)</span>
                        <span class="desc">x.com</span>
                    </span>
                </a>
            </div>
        </section>
        <form class="search" action="https://www.bing.com/search" method="GET" target="_blank" role="search"
            aria-label="Search the web">
            <input type="search" name="q" placeholder="Search the web…" autocomplete="on" />
            <div class="btn-container">
                <button type="submit" aria-label="Search the web">Search</button>
                <div style="border-right: 1px solid var(--secondary-color);opacity:.6;"></div>
                <button id="shareFile" type="button" aria-label="Upload file">Upload a file</button>
                <button id="shareScreen" type="button" aria-label="Share screen">Share Screen</button>
            </div>
        </form>

        <p class="note">Custom Start Page Demo</p>
    </main>
</body>
<script>
    // fetch variables from manifest.json into page
    document.addEventListener('DOMContentLoaded', () => {
        if (browser && browser.webfuseSession && browser.webfuseSession.env) {
            const env = browser.webfuseSession.env;

            // ---------------- helpers ----------------
            const isUnset = (val) => !val || String(val).trim() === '' || String(val).toLowerCase().trim() === 'default';

            // Accepts http(s) URLs OR bare domains like "example.com"
            const isLikelyUrl = (val) => {
                if (!val || typeof val !== 'string') return false;
                const s = val.trim();
                return /^https?:\/\//i.test(s) || /^[\w-]+(\.[\w-]+)+/i.test(s);
            };

            // If no scheme, prepend https://
            const normalizeUrl = (val) => {
                const s = String(val).trim();
                if (/^https?:\/\//i.test(s)) return s;
                if (/^[\w-]+(\.[\w-]+)+/i.test(s)) return `https://${s}`;
                return s;
            };

            // Host helpers
            const hostnameFromUrl = (urlStr) => {
                try { return new URL(normalizeUrl(urlStr)).hostname.toLowerCase(); } catch { return ''; }
            };
            const baseDomain = (host) => {
                if (!host) return '';
                let h = host.toLowerCase();
                if (h.startsWith('www.')) h = h.slice(4);
                const parts = h.split('.').filter(Boolean);
                if (parts.length >= 2) return `${parts[parts.length - 2]}.${parts[parts.length - 1]}`;
                return h;
            };
            const displayNameFromHost = (host) => {
                const base = baseDomain(host);
                const sld = base.split('.')[0] || '';
                return sld ? sld.charAt(0).toUpperCase() + sld.slice(1) : host;
            };

            // Set badge to CSS link icon (circle secondary, masked link.png primary)
            const setBadgeToLinkIcon = (badge) => {
                const img = badge.querySelector('img');
                if (img) img.remove();
                badge.classList.add('link-badge');
            };

            // Ensure badge uses an <img> with given src, creating if needed
            const setBadgeImage = (badge, src, altText) => {
                let img = badge.querySelector('img');
                if (!img) {
                    img = document.createElement('img');
                    img.alt = altText || 'Icon';
                    img.style.width = '28px';
                    img.style.height = 'auto';
                    img.style.display = 'block';
                    badge.appendChild(img);
                }
                img.src = src;
                badge.classList.remove('link-badge');
                return img;
            };

            // Try favicon chain: site /favicon.ico -> Google s2 -> fallback to link icon
            const applyFavicon = (badge, host, altText) => {
                const tryLoad = (url) => new Promise((resolve, reject) => {
                    const testImg = new Image();
                    testImg.onload = () => resolve(url);
                    testImg.onerror = reject;
                    testImg.referrerPolicy = 'no-referrer';
                    testImg.src = url;
                });

                const siteFavicon = `https://${host}/favicon.ico`;
                const googleFavicon = `https://www.google.com/s2/favicons?domain=${host}&sz=64`;

                // Chain attempts
                tryLoad(siteFavicon)
                    .then((okUrl) => setBadgeImage(badge, okUrl, altText))
                    .catch(() => tryLoad(googleFavicon)
                        .then((okUrl) => setBadgeImage(badge, okUrl, altText))
                        .catch(() => setBadgeToLinkIcon(badge)));
            };

            // ---------------- CSS variables ----------------
            if (env.primaryColor) document.documentElement.style.setProperty('--primary-color', env.primaryColor);
            if (env.secondaryColor) document.documentElement.style.setProperty('--secondary-color', env.secondaryColor);

            // ---------------- Company logo ----------------
            const logoElement = document.getElementById('company-logo');
            if (logoElement && env.CompanyLogoURL) {
                logoElement.src = env.CompanyLogoURL;
            }

            // ---------------- Optional background override ----------------
            if (!isUnset(env.BackgroundImgURL) && isLikelyUrl(env.BackgroundImgURL)) {
                document.body.style.setProperty('background-image', `url('${normalizeUrl(env.BackgroundImgURL)}')`, 'important');
            }

            // ---------------- Bookmarks (bookmarkURL_X only) ----------------
            const cards = document.querySelectorAll('.grid .card');
            const badges = document.querySelectorAll('.grid .card .badge');

            for (let i = 0; i < cards.length && i < 8; i++) {
                const card = cards[i];
                const badge = badges[i];
                if (!card || !badge) continue;

                const nameEl = card.querySelector('.label .name');
                const descEl = card.querySelector('.label .desc');

                const idx = i + 1;
                const bookmarkURL = env[`bookmarkURL_${idx}`];

                // If bookmarkURL is provided (and not default), update card link + labels + icon
                if (!isUnset(bookmarkURL) && isLikelyUrl(bookmarkURL)) {
                    const normalized = normalizeUrl(bookmarkURL);
                    const host = hostnameFromUrl(normalized);
                    const name = displayNameFromHost(host);
                    const desc = baseDomain(host);

                    // Update link, title, desc
                    card.setAttribute('href', normalized);
                    if (nameEl && name) nameEl.textContent = name;
                    if (descEl && desc) descEl.textContent = desc;

                    // Icon: try favicon(s); if none load, fallback to CSS link icon
                    applyFavicon(badge, host, name || 'Favicon');
                }
                // else: keep related card exactly as-is
            }
        } else {
            console.error('Webfuse environment data is not available.');
        }
    });

    // File share button
    document.getElementById("shareFile")
        .addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "*/*";
            input.onchange = e => browser.webfuseSession.apiRequest({
                cmd: "upload_file",
                file: e.target.files[0]
            });
            input.click();
        });

    // Screenshare button
    document.getElementById("shareScreen").addEventListener("click", () => {
        browser.webfuseSession.startScreensharing();
    });
</script>

</html>